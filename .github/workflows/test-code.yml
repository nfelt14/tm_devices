---
name: Test code
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_call:
    inputs:
      repo-name:
        description: The name of the repository to use to gate Codecov uploads.
        required: true
        type: string
      node-version:  # The node version needs to stay in sync with .readthedocs.yml
        description: The version of Node.js to install; if set, mermaid-cli will be
          installed via npm and graphviz will be installed via apt.
        required: false
        type: number
# Cancel running jobs for the same workflow and branch.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}
# IMPORTANT: Any new jobs need to be added to the check-tests-passed job to ensure they correctly gate code changes
jobs:
  # Basic testing & linting
  test-general:
    if: false  # TODO: remove
    runs-on: ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        platform: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          check-latest: true
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade tox tox-gh-actions
      - name: Run tox
        run: tox -v
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: artifact_${{ matrix.platform }}_${{ matrix.python-version }}_tests_and_linting
          path: |
            .results_*/**
            .coverage*
  # Quick testing with coverage (no linting)
  test-fast:
    runs-on: ${{ matrix.os_name }}-latest
    env:
      REPO_NAME: tektronix/${{ inputs.repo-name || 'tm_devices' }}
    strategy:
      fail-fast: false
      matrix:
        os_name: [ubuntu, windows, macos]
    steps:
      - uses: actions/checkout@v4
      - if: ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
      - if: ${{ inputs.node-version }}
        name: Install non-python documentation dependencies
        run: |
          npm install -g @mermaid-js/mermaid-cli
          sudo apt install --no-install-recommends --assume-yes graphviz
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: x  # any version
          check-latest: true
      - name: Install tox
        run: python -m pip install tox
      - name: Test
        run: tox -ve tests
      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: artifact_${{ matrix.os_name }}_tests
          path: |
            .results_*/**
            .coverage*
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: ${{ github.repository == env.REPO_NAME && !cancelled() }}
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./.coverage_tests.xml
          name: codecov-${{ matrix.os_name }}
          fail_ci_if_error: true
  upload-event-file:
    if: ${{ !cancelled() }}
    needs: test-fast
    runs-on: ubuntu-latest
    permissions:  # TODO: remove permissions
      checks: write
      pull-requests: write
      actions: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: artifacts/**/.results_tests/results.xml
          large_files: true
          action_fail_on_inconclusive: true
          report_individual_runs: true
          test_changes_limit: 20
          check_run: false  # disable adding the check since it shows up attached to a random workflow run
          json_file: .results.json
#        uses: mikepenz/action-junit-report@v4
#        with:
#          report_paths: artifacts/**/.results_tests/results.xml
#          check_name: Test Results
##          commit: ...
#          require_tests: true
#          check_annotations: true
#          job_summary: true
      - uses: actions/upload-artifact@v4
        with:
          name: Event File
          path: ${{ github.event_path }}
  # Check that all jobs passed
  check-tests-passed:
    if: ${{ !cancelled() }}
    needs: [test-general, test-fast, upload-event-file]
    runs-on: ubuntu-latest
    steps:
      - name: Decide whether the needed jobs succeeded or failed
        uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}
